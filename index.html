<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taste of Home - Authentic Home Cooked Cuisine</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="partial-header"></div>
    <div id="partial-hero"></div>
    <div id="partial-main"></div>
    <div id="partial-footer"></div>

    <script>
        // Load header, hero, main and footer partials asynchronously and expose a promise
        window.partialsLoaded = (async function() {
            const parts = [
                ['partial-header', 'header.html'],
                ['partial-hero', 'hero.html'],
                ['partial-main', 'main.html'],
                ['partial-footer', 'footer.html']
            ];

            await Promise.all(parts.map(async ([id, url]) => {
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error('Failed to load ' + url + ': ' + res.status);
                    const html = await res.text();
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = html;
                } catch (e) {
                    console.error(e);
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '';
                }
            }));
        })();
    </script>

    <div class="modal" id="successModal">
        <div class="modal-content">
            <h3>ðŸŽ‰ Order Received!</h3>
            <p>Thank you for your order! We'll be in touch soon to confirm the details.</p>
            <button class="close-modal" onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        let menuData = {};
        let form, orderSummary, summaryContent, modal;

        // Initialize after DOM is loaded and partials have been inserted
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for partials (header/hero/main/footer) to load if they haven't yet
            try {
                if (window.partialsLoaded) await window.partialsLoaded;
            } catch (e) { console.warn('partials load error:', e); }

            console.log('DOM loaded');
            form = document.getElementById('orderForm');
            orderSummary = document.getElementById('orderSummary');
            summaryContent = document.getElementById('summaryContent');
            modal = document.getElementById('successModal');

            console.log('Form element:', form);
            console.log('Order summary:', orderSummary);

            if (!form) {
                console.error('Form not found!');
                return;
            }

            // Set minimum date to today
            const dateInput = document.getElementById('delivery-date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.setAttribute('min', today);

            // Load menu data
            loadMenuData();
        });

        // Load menu data - tries XML first, falls back to hardcoded data
        async function loadMenuData() {
            console.log('=== LOADING MENU DATA ===');
            
            // Try to load from XML first
            try {
                console.log('Attempting to load menu.xml...');
                const response = await fetch('menu.xml');
                
                if (response.ok) {
                    const xmlText = await response.text();
                    console.log('XML loaded, length:', xmlText.length);
                    
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

                    // Check for parsing errors
                    const parserError = xmlDoc.querySelector('parsererror');
                    if (parserError) {
                        throw new Error('XML parsing error');
                    }

                    // Parse dishes
                    menuData.dishes = Array.from(xmlDoc.querySelectorAll('dishes > dish')).map(dish => ({
                        id: dish.querySelector('id').textContent,
                        name: dish.querySelector('name').textContent,
                        description: dish.querySelector('description').textContent,
                        emoji: dish.querySelector('emoji').textContent,
                        price: parseFloat(dish.querySelector('base_price').textContent),
                        allowToppings: dish.querySelector('allow_toppings').textContent === 'true'
                    }));

                    // Parse portions
                    menuData.portions = {};
                    xmlDoc.querySelectorAll('portions > portion').forEach(portion => {
                        const id = portion.querySelector('id').textContent;
                        menuData.portions[id] = {
                            name: portion.querySelector('name').textContent,
                            price: parseFloat(portion.querySelector('price').textContent)
                        };
                    });

                    // Parse toppings
                    menuData.toppings = {};
                    xmlDoc.querySelectorAll('toppings > topping').forEach(topping => {
                        const id = topping.querySelector('id').textContent;
                        menuData.toppings[id] = {
                            name: topping.querySelector('name').textContent,
                            emoji: topping.querySelector('emoji').textContent,
                            price: parseFloat(topping.querySelector('price').textContent)
                        };
                    });

                    // Parse extras
                    menuData.extras = {};
                    xmlDoc.querySelectorAll('extras > extra').forEach(extra => {
                        const id = extra.querySelector('id').textContent;
                        menuData.extras[id] = {
                            name: extra.querySelector('name').textContent,
                            emoji: extra.querySelector('emoji').textContent,
                            price: parseFloat(extra.querySelector('price').textContent)
                        };
                    });

                    // Parse drinks
                    menuData.drinks = {};
                    xmlDoc.querySelectorAll('drinks > drink').forEach(drink => {
                        const id = drink.querySelector('id').textContent;
                        menuData.drinks[id] = {
                            name: drink.querySelector('name').textContent,
                            price: parseFloat(drink.querySelector('price').textContent)
                        };
                    });

                    // Parse desserts
                    menuData.desserts = {};
                    xmlDoc.querySelectorAll('desserts > dessert').forEach(dessert => {
                        const id = dessert.querySelector('id').textContent;
                        menuData.desserts[id] = {
                            name: dessert.querySelector('name').textContent,
                            price: parseFloat(dessert.querySelector('price').textContent)
                        };
                    });

                    console.log('XML parsed successfully from menu.xml');
                } else {
                    throw new Error('Failed to fetch menu.xml');
                }
            } catch (error) {
                console.log('XML loading failed, using hardcoded data:', error.message);
                
                // Fallback to hardcoded data (silent fallback, no alert)
                menuData = {
                    dishes: [
                        { id: 'jollof', name: 'Jollof Rice', description: 'Our famous Jollof rice', emoji: 'ðŸš', price: 12.00, allowToppings: false },
                        { id: 'waakye', name: 'Waakye', description: 'Traditional rice and beans', emoji: 'ðŸ›', price: 12.00, allowToppings: false },
                        { id: 'fried-rice', name: 'Special Fried Rice', description: 'Our house special', emoji: 'ðŸœ', price: 12.00, allowToppings: true }
                    ],
                    portions: {
                        regular: { name: 'Regular', price: 12.00 },
                        large: { name: 'Large', price: 16.00 },
                        family: { name: 'Family Size (Serves 4)', price: 45.00 }
                    },
                    toppings: {
                        beef: { name: 'Beef', emoji: 'ðŸ¥©', price: 3.00 },
                        pork: { name: 'Pork', emoji: 'ðŸ·', price: 3.00 },
                        duck: { name: 'Duck', emoji: 'ðŸ¦†', price: 4.00 },
                        prawns: { name: 'Prawns', emoji: 'ðŸ¦', price: 5.00 },
                        chicken: { name: 'Chicken', emoji: 'ðŸ—', price: 3.00 }
                    },
                    extras: {
                        spareribs: { name: 'Spare Ribs', emoji: 'ðŸ–', price: 4.00 },
                        salad: { name: 'Fresh Salad', emoji: 'ðŸ¥—', price: 2.50 }
                    },
                    drinks: {
                        coke: { name: 'Coca-Cola', price: 1.50 },
                        sprite: { name: 'Sprite', price: 1.50 },
                        fanta: { name: 'Fanta', price: 1.50 },
                        water: { name: 'Bottled Water', price: 1.00 },
                        juice: { name: 'Fruit Juice', price: 2.00 },
                        malta: { name: 'Malta Guinness', price: 2.50 }
                    },
                    desserts: {
                        'chin-chin': { name: 'Chin Chin', price: 3.00 },
                        'puff-puff': { name: 'Puff Puff', price: 3.50 },
                        plantain: { name: 'Sweet Plantain', price: 2.50 },
                        bofrot: { name: 'Bofrot (African Donuts)', price: 3.00 }
                    }
                };
            }
            
            console.log('Menu data loaded:', menuData);
            console.log('Dishes count:', menuData.dishes.length);
            populateMenuUI();
            setupEventListeners();
        }

        // Populate the UI with menu data
        function populateMenuUI() {
            console.log('=== POPULATE MENU UI CALLED ===');
            console.log('Populating menu UI...');
            console.log('Menu data:', menuData);
            
            // Populate dish dropdown
            const dishSelect = document.getElementById('dish');
            console.log('Dish select element:', dishSelect);
            console.log('Current dish options:', dishSelect.options.length);
            
            menuData.dishes.forEach(dish => {
                const option = document.createElement('option');
                option.value = dish.id;
                option.textContent = `${dish.name} - Â£${dish.price.toFixed(2)}`;
                dishSelect.appendChild(option);
                console.log('Added dish option:', dish.name);
            });
            console.log('Dishes added:', menuData.dishes.length);
            console.log('Final dish options:', dishSelect.options.length);

            // Populate portion dropdown
            const portionSelect = document.getElementById('portion');
            Object.keys(menuData.portions).forEach(key => {
                const portion = menuData.portions[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${portion.name} - Â£${portion.price.toFixed(2)}`;
                portionSelect.appendChild(option);
            });
            console.log('Portions added:', Object.keys(menuData.portions).length);

            // Populate toppings
            const toppingsGrid = document.querySelector('#toppingsGroup .toppings-grid');
            // When rendering toppings, mark stew toppings as waakye-only and protein toppings as fried-rice-only
            const waakyeOnly = new Set(['gammon-stew', 'chicken-stew', 'goat-stew', 'beef-stew']);
            const friedRiceOnly = new Set(['beef', 'pork', 'duck', 'prawns', 'chicken']);
            Object.keys(menuData.toppings).forEach(key => {
                const topping = menuData.toppings[key];
                const div = document.createElement('div');
                div.className = 'topping-option';
                if (waakyeOnly.has(key)) div.dataset.dishes = 'waakye';
                else if (friedRiceOnly.has(key)) div.dataset.dishes = 'fried-rice';
                else div.dataset.dishes = 'all';
                div.innerHTML = `
                    <input type="checkbox" id="${key}" name="toppings" value="${key}">
                    <label for="${key}" class="topping-label">${topping.emoji} ${topping.name}<br>+Â£${topping.price.toFixed(2)}</label>
                `;
                toppingsGrid.appendChild(div);
            });

            // Populate extras as quantity controls
            const extrasGrid = document.querySelector('#extrasGroup .toppings-grid');
            extrasGrid.innerHTML = '';
            Object.keys(menuData.extras).forEach(key => {
                const extra = menuData.extras[key];
                const div = document.createElement('div');
                div.className = 'topping-option';
                div.innerHTML = `
                    <label class="topping-label" for="${key}-qty">${extra.emoji} ${extra.name}<br>Â£${extra.price.toFixed(2)} each</label>
                    <input type="number" id="${key}-qty" name="extras-qty" data-item="${key}" min="0" max="20" value="0" style="width: 100%; margin-top:0.5rem; padding:0.5rem;">
                `;
                extrasGrid.appendChild(div);
            });

            // Populate drinks as quantity controls
            const drinksGrid = document.getElementById('drinksGrid');
            if (drinksGrid) drinksGrid.innerHTML = '';
            Object.keys(menuData.drinks).forEach(key => {
                const drink = menuData.drinks[key];
                const div = document.createElement('div');
                div.className = 'topping-option';
                div.innerHTML = `
                    <label class="topping-label" for="${key}-qty">${drink.name}<br>Â£${drink.price.toFixed(2)} each</label>
                    <input type="number" id="${key}-qty" name="drink-qty" data-item="${key}" min="0" max="20" value="0" style="width:100%; margin-top:0.5rem; padding:0.5rem;">
                `;
                if (drinksGrid) drinksGrid.appendChild(div);
            });

            // Populate desserts as quantity controls
            const dessertsGrid = document.getElementById('dessertsGrid');
            if (dessertsGrid) dessertsGrid.innerHTML = '';
            Object.keys(menuData.desserts).forEach(key => {
                const dessert = menuData.desserts[key];
                const div = document.createElement('div');
                div.className = 'topping-option';
                div.innerHTML = `
                    <label class="topping-label" for="${key}-qty">${dessert.name}<br>Â£${dessert.price.toFixed(2)} each</label>
                    <input type="number" id="${key}-qty" name="dessert-qty" data-item="${key}" min="0" max="20" value="0" style="width:100%; margin-top:0.5rem; padding:0.5rem;">
                `;
                if (dessertsGrid) dessertsGrid.appendChild(div);
            });
            
            console.log('=== MENU UI POPULATION COMPLETE ===');
        }

        // Load menu data from XML
        async function loadMenuData() {
            try {
                const response = await fetch('menu.xml');
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

                // Parse dishes
                menuData.dishes = Array.from(xmlDoc.querySelectorAll('dishes > dish')).map(dish => ({
                    id: dish.querySelector('id').textContent,
                    name: dish.querySelector('name').textContent,
                    description: dish.querySelector('description').textContent,
                    emoji: dish.querySelector('emoji').textContent,
                    price: parseFloat(dish.querySelector('base_price').textContent),
                    allowToppings: dish.querySelector('allow_toppings').textContent === 'true'
                }));

                // Parse portions
                menuData.portions = {};
                xmlDoc.querySelectorAll('portions > portion').forEach(portion => {
                    const id = portion.querySelector('id').textContent;
                    menuData.portions[id] = {
                        name: portion.querySelector('name').textContent,
                        price: parseFloat(portion.querySelector('price').textContent)
                    };
                });

                // Parse toppings
                menuData.toppings = {};
                xmlDoc.querySelectorAll('toppings > topping').forEach(topping => {
                    const id = topping.querySelector('id').textContent;
                    menuData.toppings[id] = {
                        name: topping.querySelector('name').textContent,
                        emoji: topping.querySelector('emoji').textContent,
                        price: parseFloat(topping.querySelector('price').textContent)
                    };
                });

                // Parse extras
                menuData.extras = {};
                xmlDoc.querySelectorAll('extras > extra').forEach(extra => {
                    const id = extra.querySelector('id').textContent;
                    menuData.extras[id] = {
                        name: extra.querySelector('name').textContent,
                        emoji: extra.querySelector('emoji').textContent,
                        price: parseFloat(extra.querySelector('price').textContent)
                    };
                });

                // Parse drinks
                menuData.drinks = {};
                xmlDoc.querySelectorAll('drinks > drink').forEach(drink => {
                    const id = drink.querySelector('id').textContent;
                    menuData.drinks[id] = {
                        name: drink.querySelector('name').textContent,
                        price: parseFloat(drink.querySelector('price').textContent)
                    };
                });

                // Parse desserts
                menuData.desserts = {};
                xmlDoc.querySelectorAll('desserts > dessert').forEach(dessert => {
                    const id = dessert.querySelector('id').textContent;
                    menuData.desserts[id] = {
                        name: dessert.querySelector('name').textContent,
                        price: parseFloat(dessert.querySelector('price').textContent)
                    };
                });

                populateMenuUI();
                // Ensure event listeners are attached (in case this function was overridden earlier)
                if (typeof setupEventListeners === 'function') {
                    try { setupEventListeners(); } catch (e) { console.error('setupEventListeners error:', e); }
                }

                // Auto-select the first dish so optional sections (extras/drinks/desserts/toppings) appear
                try {
                    if (menuData.dishes && menuData.dishes.length > 0) {
                        // Prefer 'fried-rice' as the default selected dish if available
                        const preferred = menuData.dishes.find(d => d.id === 'fried-rice');
                        const firstDishId = preferred ? preferred.id : menuData.dishes[0].id;
                        const dishSelectEl = document.getElementById('dish');
                        if (dishSelectEl) {
                            dishSelectEl.value = firstDishId;
                            dishSelectEl.dispatchEvent(new Event('change'));
                        }
                    }
                } catch (e) { console.error('Auto-select dish error:', e); }
            } catch (error) {
                console.error('Error loading menu data:', error);
                alert('Failed to load menu. Please refresh the page.');
            }
        }

        // (duplicate populateMenuUI removed; the primary populateMenuUI defined earlier is used)

        // Return default included toppings for a dish (free with the dish)
        function getDefaultIncludedToppingsForDish(dishId) {
            if (!dishId) return [];
            // For now only fried-rice includes pork and prawns by default
            if (dishId === 'fried-rice') return ['pork', 'prawns'];
            return [];
        }

        // (Intentionally left no portion-price adjustment here)

        function setupEventListeners() {
            console.log('Setting up event listeners');
            console.log('Form in setupEventListeners:', form);
            console.log('Type of form:', typeof form);
            
            if (!form) {
                console.error('Form is undefined in setupEventListeners!');
                return;
            }

            try {
                // Update summary when inputs change
                console.log('Adding change listener to form...');
                form.addEventListener('change', updateSummary);
                console.log('Change listener added successfully');

                // Show/hide sections based on dish selection
                const dishSelect = document.getElementById('dish');
                console.log('Dish select element:', dishSelect);
                
                dishSelect.addEventListener('change', function() {
                    const selectedDish = this.value;
                    const toppingsGroup = document.getElementById('toppingsGroup');
                    const extrasGroup = document.getElementById('extrasGroup');
                    const drinksGroup = document.getElementById('drinksGroup');
                    const dessertGroup = document.getElementById('dessertGroup');

                    if (selectedDish) {
                        // Show extras, drinks, and desserts for any dish
                        extrasGroup.style.display = 'block';
                        drinksGroup.style.display = 'block';
                        dessertGroup.style.display = 'block';

                        // Check if this dish allows toppings
                        const dish = menuData.dishes.find(d => d.id === selectedDish);
                        if (dish && dish.allowToppings) {
                            toppingsGroup.style.display = 'block';

                            // Show/hide individual topping options depending on which dish(s) they apply to
                            document.querySelectorAll('#toppingsGroup .topping-option').forEach(div => {
                                const avail = div.dataset.dishes || 'all';
                                if (avail === 'all' || avail.split(',').includes(selectedDish)) {
                                    div.style.display = '';
                                } else {
                                    // hide toppings not available for this dish and uncheck them
                                    div.style.display = 'none';
                                    const cb = div.querySelector('input[name="toppings"]');
                                    if (cb) cb.checked = false;
                                }
                            });

                            // If fried-rice is selected, pre-check pork and prawns by default
                            if (selectedDish === 'fried-rice') {
                                document.querySelectorAll('#toppingsGroup input[name="toppings"]').forEach(cb => {
                                    if (cb.id === 'pork' || cb.id === 'prawns') cb.checked = true;
                                });
                            }
                        } else {
                            toppingsGroup.style.display = 'none';
                            // Uncheck all toppings if switching away from a toppings-enabled dish
                            document.querySelectorAll('#toppingsGroup input[name="toppings"]').forEach(cb => cb.checked = false);
                        }
                    } else {
                        // Hide all optional sections if no dish selected
                        toppingsGroup.style.display = 'none';
                        extrasGroup.style.display = 'none';
                        drinksGroup.style.display = 'none';
                        dessertGroup.style.display = 'none';

                        // Reset any quantities or checks when nothing is selected
                        document.querySelectorAll('#toppingsGroup input[name="toppings"]').forEach(cb => cb.checked = false);
                        document.querySelectorAll('input[name="extras-qty"]').forEach(n => n.value = 0);
                        document.querySelectorAll('input[name="drink-qty"]').forEach(n => n.value = 0);
                        document.querySelectorAll('input[name="dessert-qty"]').forEach(n => n.value = 0);
                    }
                    
                    // No portion label changes; update summary to reflect any default toppings removed
                    updateSummary();
                });

                // Handle form submission
                form.addEventListener('submit', function(e) {
                    e.preventDefault();

                    // If selected dish requires toppings (fried-rice) ensure at least one topping is chosen
                    const dishSelect = document.getElementById('dish');
                    const selectedDishId = dishSelect ? dishSelect.value : null;
                    const dishObj = menuData.dishes ? menuData.dishes.find(d => d.id === selectedDishId) : null;
                    const requiresToppings = dishObj && dishObj.allowToppings;

                    if (requiresToppings) {
                        const checked = document.querySelectorAll('#toppingsGroup input[name="toppings"]:checked').length;
                        if (checked === 0) {
                            // show inline validation message under toppingsGroup
                            const toppingsGroup = document.getElementById('toppingsGroup');
                            if (toppingsGroup) {
                                let msg = toppingsGroup.querySelector('.validation-msg');
                                if (!msg) {
                                    msg = document.createElement('div');
                                    msg.className = 'validation-msg';
                                    msg.style.color = '#b23a36';
                                    msg.style.marginTop = '0.75rem';
                                    msg.style.fontWeight = '600';
                                    toppingsGroup.appendChild(msg);
                                }
                                msg.textContent = 'Please select at least one protein topping for Special Fried Rice.';
                                // focus the first topping checkbox if available
                                const firstCheckbox = toppingsGroup.querySelector('input[name="toppings"]');
                                if (firstCheckbox) firstCheckbox.focus();
                            }
                            return; // prevent submission
                        }
                    }

                    // Clear any validation message
                    const toppingsGroup = document.getElementById('toppingsGroup');
                    if (toppingsGroup) {
                        const msg = toppingsGroup.querySelector('.validation-msg');
                        if (msg) msg.remove();
                    }

                    // Show success modal
                    modal.classList.add('active');
                    
                    // Reset form after a delay
                    setTimeout(() => {
                        form.reset();
                        orderSummary.style.display = 'none';
                    }, 500);
                });
                
                console.log('Event listeners set up successfully');
            } catch (error) {
                console.error('Error in setupEventListeners:', error);
                console.error('Error stack:', error.stack);
            }
        }

        function updateSummary() {
            const dish = document.getElementById('dish').value;
            const portion = document.getElementById('portion').value;
            const selectedToppings = Array.from(document.querySelectorAll('input[name="toppings"]:checked'))
                .map(el => el.value);

            // Read extras/drinks/desserts quantities
            const selectedExtrasQty = Array.from(document.querySelectorAll('input[name="extras-qty"]'))
                .map(el => ({ id: el.dataset.item, qty: parseInt(el.value, 10) || 0 }))
                .filter(i => i.qty > 0);

            const selectedDrinksQty = Array.from(document.querySelectorAll('input[name="drink-qty"]'))
                .map(el => ({ id: el.dataset.item, qty: parseInt(el.value, 10) || 0 }))
                .filter(i => i.qty > 0);

            const selectedDessertsQty = Array.from(document.querySelectorAll('input[name="dessert-qty"]'))
                .map(el => ({ id: el.dataset.item, qty: parseInt(el.value, 10) || 0 }))
                .filter(i => i.qty > 0);

            if (!dish || !portion) {
                orderSummary.style.display = 'none';
                return;
            }

            // Clear toppings validation message if user selected toppings or dish doesn't require toppings
            try {
                const toppingsGroup = document.getElementById('toppingsGroup');
                if (toppingsGroup) {
                    const msg = toppingsGroup.querySelector('.validation-msg');
                    if (msg && (selectedToppings.length > 0 || dish !== 'fried-rice')) {
                        msg.remove();
                    }
                }
            } catch (e) { /* ignore */ }

            // Determine default included toppings for this dish
            const defaultIncluded = getDefaultIncludedToppingsForDish(dish);

            // Base portion price (full)
            const portionFullPrice = menuData.portions[portion].price;

            let total = portionFullPrice;
            let toppingsTotal = 0;
            let extrasTotal = 0;
            let drinksTotal = 0;
            let dessertsTotal = 0;

            // Only charge for toppings that are not included by default
            selectedToppings.forEach(topping => {
                if (!defaultIncluded.includes(topping)) {
                    toppingsTotal += menuData.toppings[topping].price;
                }
            });

            // Extras: multiply quantity by unit price
            selectedExtrasQty.forEach(item => {
                const price = (menuData.extras[item.id] && menuData.extras[item.id].price) || 0;
                extrasTotal += price * item.qty;
            });

            // Drinks
            selectedDrinksQty.forEach(item => {
                const price = (menuData.drinks[item.id] && menuData.drinks[item.id].price) || 0;
                drinksTotal += price * item.qty;
            });

            // Desserts
            selectedDessertsQty.forEach(item => {
                const price = (menuData.desserts[item.id] && menuData.desserts[item.id].price) || 0;
                dessertsTotal += price * item.qty;
            });

            // Subtract any default toppings that the user has explicitly UNCHECKED
            const removedDefaults = defaultIncluded.filter(id => !selectedToppings.includes(id));
            let removedDefaultsTotal = 0;
            removedDefaults.forEach(id => {
                if (menuData.toppings[id]) {
                    removedDefaultsTotal += menuData.toppings[id].price;
                    total -= menuData.toppings[id].price;
                }
            });

            total += toppingsTotal + extrasTotal + drinksTotal + dessertsTotal;

            const dishData = menuData.dishes.find(d => d.id === dish);
            const portionData = menuData.portions[portion];

            let summaryHTML = `
                <div class="summary-item">
                    <span>Dish:</span>
                    <span>${dishData.name}</span>
                </div>
                <div class="summary-item">
                    <span>Portion:</span>
                    <span>${portionData.name}</span>
                </div>
                <div class="summary-item">
                    <span>Base Price:</span>
                    <span>Â£${portionFullPrice.toFixed(2)}</span>
                </div>
            `;

            if (selectedToppings.length > 0) {
                const included = selectedToppings.filter(t => defaultIncluded.includes(t)).map(t => menuData.toppings[t].name);
                const paid = selectedToppings.filter(t => !defaultIncluded.includes(t)).map(t => menuData.toppings[t].name);

                if (included.length > 0) {
                    summaryHTML += `
                        <div class="summary-item">
                            <span>Included Proteins:</span>
                            <span>${included.join(', ')}</span>
                        </div>
                    `;
                }

                if (removedDefaults.length > 0) {
                    const removedNames = removedDefaults.map(id => menuData.toppings[id] ? menuData.toppings[id].name : id).join(', ');
                    summaryHTML += `
                        <div class="summary-item">
                            <span>Removed Proteins:</span>
                            <span>-${removedNames} - Â£${removedDefaultsTotal.toFixed(2)}</span>
                        </div>
                    `;
                }

                if (paid.length > 0) {
                    summaryHTML += `
                        <div class="summary-item">
                            <span>Protein Toppings:</span>
                            <span>${paid.join(', ')}</span>
                        </div>
                        <div class="summary-item">
                            <span>Toppings Cost:</span>
                            <span>Â£${toppingsTotal.toFixed(2)}</span>
                        </div>
                    `;
                }
            }

            if (selectedExtrasQty.length > 0) {
                selectedExtrasQty.forEach(item => {
                    const name = menuData.extras[item.id] ? menuData.extras[item.id].name : item.id;
                    const unit = menuData.extras[item.id] ? menuData.extras[item.id].price : 0;
                    summaryHTML += `
                        <div class="summary-item">
                            <span>Extra: ${name} x${item.qty}</span>
                            <span>Â£${(unit * item.qty).toFixed(2)}</span>
                        </div>
                    `;
                });
                summaryHTML += `
                    <div class="summary-item">
                        <span>Extras Cost:</span>
                        <span>Â£${extrasTotal.toFixed(2)}</span>
                    </div>
                `;
            }

            if (selectedDrinksQty.length > 0) {
                selectedDrinksQty.forEach(item => {
                    const name = menuData.drinks[item.id] ? menuData.drinks[item.id].name : item.id;
                    const unit = menuData.drinks[item.id] ? menuData.drinks[item.id].price : 0;
                    summaryHTML += `
                        <div class="summary-item">
                            <span>Drink: ${name} x${item.qty}</span>
                            <span>Â£${(unit * item.qty).toFixed(2)}</span>
                        </div>
                    `;
                });
                summaryHTML += `
                    <div class="summary-item">
                        <span>Drinks Cost:</span>
                        <span>Â£${drinksTotal.toFixed(2)}</span>
                    </div>
                `;
            }

            if (selectedDessertsQty.length > 0) {
                selectedDessertsQty.forEach(item => {
                    const name = menuData.desserts[item.id] ? menuData.desserts[item.id].name : item.id;
                    const unit = menuData.desserts[item.id] ? menuData.desserts[item.id].price : 0;
                    summaryHTML += `
                        <div class="summary-item">
                            <span>Dessert: ${name} x${item.qty}</span>
                            <span>Â£${(unit * item.qty).toFixed(2)}</span>
                        </div>
                    `;
                });
                summaryHTML += `
                    <div class="summary-item">
                        <span>Desserts Cost:</span>
                        <span>Â£${dessertsTotal.toFixed(2)}</span>
                    </div>
                `;
            }

            summaryHTML += `
                <div class="summary-item">
                    <span>Includes Free:</span>
                    <span>Homemade Shito</span>
                </div>
                <div class="summary-item">
                    <span>Total:</span>
                    <span>Â£${total.toFixed(2)}</span>
                </div>
            `;

            summaryContent.innerHTML = summaryHTML;
            orderSummary.style.display = 'block';
        }

        function closeModal() {
            modal.classList.remove('active');
        }
    </script>
</body>
</html>
